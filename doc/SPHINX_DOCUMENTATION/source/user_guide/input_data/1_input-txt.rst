.. _1_inputfile:

===============================
input.txt
===============================

++++++++++++++++++++++++++++++++++++++++++
Parameters to specify in file
++++++++++++++++++++++++++++++++++++++++++
We can list the arguments of ``input.txt`` file as follow:


.. hint::

  Some arguments are not anymore available in dassflow2d-wrap:

  - all mesh parameters
  - verbose
  - w_norms
  - w_exact
  - dta
  - use_Qobs







+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| parameter        |  options           | description                                                                                                                 | default value |
+==================+====================+=============================================================================================================================+===============+
| **MESH**          **PARAMETERS**                                                                                                                                                    |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| mesh_name        |                    | name of the mesh file                                                                                                       | NA            |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **SIMULATION**     **PARAMETERS**                                                                                                                                                   |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| ts               |  in [s]            | Time of simulation                                                                                                          |  NA           |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| dtw              |  in [s]            | Time step to output a result file of all model unknows as some inputs                                                       |   2000        |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| dtp              |  in [s]            | corrective to estimate writting time step:used to estimate correspondance between writting timestep and calculation timestep|   60          |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| dta              |  in [s]            | Time step to generate boundary inflow/outflow files in order to use the adjoint mode. **OBSOLETE**                          |    NA         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **NUMERICAL**      **PARAMETERS**                                                                                                                                   |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| temp_scheme      |                    |   choice of the numerical scheme to integrate in time                                                                       | 'euler'       |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  euler             |  The classical first order Euler explicit time stepping with a splitted implicit discretization of the friction source term |               |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  imex              | A Implicit-Explicit Runge-Kutta time stepping scheme giving a global second order method with an implicit discretization of |               |
|                  |                    | the friction source term.                                                                                                   |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| spatial_scheme   |                    | choice of the numerical scheme to integrate in space                                                                        |   'first_b1'  |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  first_b1          | The Finite Volume Godonov scheme with the Audusse and al. well-balanced property                                            |               |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  muscl_b1          | The Finite Volume Godonov scheme with linear reconstructions at edge with the Audusse and al. well-balanced property        |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| friction         |                    | Friction law to apply                                                                                                       |  1            |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  0                 | no friction is applied                                                                                                      |               |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  1                 | manning-stricler law is applied (can be of the form  **sf = n*h^manning_beta)**                                             |               |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  2                 | Ferguson like law   :math:`(8/f)^{1/2}=a(h/D)^{b}`                                                                          |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| heps             | in [m]             | Cut-off water depth that can be usefull to stabilize schemes.                                                               | 1E-3          |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **CALCULATION TIMESTEP PARAMETERS**                                                                                                                                 |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| adapt_dt         |                    | Way of estimation of calculation timestep                                                                                   |   1           |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  0                 | The time step is fixed at the must provided **dt** value                                                                    |               |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  1                 | The time step is calculated and the **cfl** number is applied                                                               |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| dt               | in [s]             | Fixed time step                                                                                                             |   5           |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| cfl              |:math:`\in [0,1]`   | CFL-like number with a value                                                                                                |   0.8         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **GHOST CELLS TREATMENT**                                                                                                                                           |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| feedback_inflow  |  0                 | no activate                                                                                                                 |   1           |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  1                 | activate a feedback control on ghost bathymetries to obtain the proper discharg desired at a subset                         |               |
|                  |                    | of the computational domain boundary                                                                                        |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| coef_feedback    |                    | coefficient applied to the feedback control                                                                                 |    0.1        |
|                  |                    | (be carefull to not enter a too strong value that will exhibit severe oscillations on the discharg)                         |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **PHYSICAL**       **PARAMETERS**                                                                                                                                   |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| g                |in                  |   gravitational acceleration                                                                                                |  9.81         |
|                  |:math:`[m.s^{-2}]`  |                                                                                                                             |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **WRITING OUTPUTS PARAMETERS**                                                                                                                                      |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| w_tecplot        |  0                 | no activate                                                                                                                 |   0           |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  1                 | output of result files in ASCII Tecplot format                                                                              |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| w_gnuplot        |  0                 | no activate                                                                                                                 |   0           |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  1                 | output of result files in ASCII Gnuplot format                                                                              |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| w_vtk            |  0                 | no activate                                                                                                                 |  0            |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  1                 | output of result files in ASCII VTK format                                                                                  |               |
+                  +--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|                  |  2                 | output of result files in binary VTK format                                                                                 |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| **ASSIMILATION PARAMETERS**          (always 0 to not activate and 1 to activate)                                                                                   |               |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| w_obs            |  0/1               | output of observations result files and related cost function. The ``obs.txt`` file need to be prescribed.                  |    0          |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| use_obs          |  0/1               | maximum number of adjoint time iterations to perform. It can be usefull to manage the memory consumption.                   |     0         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| use_Qobs         |  0/1               | activate the cost function calculation with the innovQ vector.  **obsolete**                                                |     0         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_hydrograph     |  0/1               | activate inference of hydrograph                                                                                            |       0       |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_ratcurve       |  0/1               | activate inference of rating curve                                                                                          |     0         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_bathy          |  0/1               | activate inference of bathymetry                                                                                            |      0        |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_ic             |  0/1               | activate inference of  initial conditions (of h,u,v)                                                                        |     0         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_manning        |  0/1               | activate inference of  manning parameter                                                                                    |      0        |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_manning _beta  |  0/1               | activate inference of  manning beta parameter                                                                               |       0       |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_rain           |  0/1               | activate inference of  rain **todocument**                                                                                  |      0        |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
| c_infil          |  0/1               | activate inference of   infiltration parameter **todocument**                                                               |       0       |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|max_nt_for_adjoint|                    | activate the cost function calculation with the innovation vector                                                           |     2500      |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|restart_min       |                    |  maximum number of minimization iterations to perform. It can be usefull to cut a very long minimization process.           |     0         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|eps_min           |                    |  m1qn3 parameter                                                                                                            |     1E-4      |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+
|eps_xxx           |                    |  to add                                                                                                                     |     X         |
+------------------+--------------------+-----------------------------------------------------------------------------------------------------------------------------+---------------+


.. dropdown:: requirements/constraints


    +------------------+--------------------+------------------------------------------------------------+
    | parameter        | additional info    | requirements                                               |
    +==================+====================+============================================================+
    | **MESH**          **PARAMETERS**      |                                                            |
    +------------------+--------------------+------------------------------------------------------------+
    | mesh_name        |                    |           must be provided                                 |
    +------------------+--------------------+------------------------------------------------------------+
    | **SIMULATION**     **PARAMETERS**     |                                                            |
    +------------------+--------------------+------------------------------------------------------------+
    | ts               |                    |           must be provided                                 |
    +------------------+--------------------+------------------------------------------------------------+
    | dtw              |                    |     dtw < ts                                               |
    +------------------+--------------------+------------------------------------------------------------+
    | dtp              |                    |     dtp<dtw and dtp<dtw                                    |
    +------------------+--------------------+------------------------------------------------------------+
    | **NUMERICAL**      **PARAMETERS**     |                                                            |
    +------------------+--------------------+------------------------------------------------------------+
    | temp_scheme      |                    |                                                            |
    +------------------+--------------------+------------------------------------------------------------|
    |                  |  euler             | goes along first_b1 spatial scheme                         |
    +                  +--------------------+------------------------------------------------------------|
    |                  |  imex              | goes along muscl_b1 spatial scheme                         |
    +------------------+--------------------+------------------------------------------------------------|
    | spatial_scheme   |                    | choice of the numerical scheme to integrate in space       |
    +------------------+--------------------+------------------------------------------------------------+
    |                  |  first_b1          | goes along euler temporal scheme                           |
    +                  +--------------------+------------------------------------------------------------+
    |                  |  muscl_b1          | goes along imex temporal scheme                            |
    +------------------+--------------------+------------------------------------------------------------+
    | friction         |                    | Friction law to apply                                      |
    +------------------+--------------------+------------------------------------------------------------+
    |                  |  0                 | no friction is applied                                     |
    +                  +--------------------+------------------------------------------------------------+
    |                  |  1                 | manning_beta must be provided                              |
    +                  +--------------------+------------------------------------------------------------+
    |                  |  2                 | Manning beta and macro rugosity must be provided           |
    +------------------+--------------------+------------------------------------------------------------+
    | heps             |                    | can be 0 with present solvers                              |
    +------------------+--------------------+------------------------------------------------------------+
    | **CALCULATION TIMESTEP PARAMETERS**                                                                |
    +------------------+--------------------+------------------------------------------------------------+
    | adapt_dt         |                    | no constraint                                              |
    +------------------+--------------------+------------------------------------------------------------+
    | dt               |                    | must be adapt_dt = 0                                       |
    +------------------+--------------------+------------------------------------------------------------+
    | cfl              |                    |  must be adapt_dt = 1, :math:`\in [0,1]`                   |
    +------------------+--------------------+------------------------------------------------------------+
    | **GHOST CELLS TREATMENT**                                                                          |
    +------------------+--------------------+------------------------------------------------------------+
    | feedback_inflow  |                    | no constraint                                              |
    +------------------+--------------------+------------------------------------------------------------+
    | coef_feedback    |                    | coef_feedback>0                                            |
    +------------------+--------------------+------------------------------------------------------------+
    | **PHYSICAL**       **PARAMETERS**                                                                  |
    +------------------+--------------------+------------------------------------------------------------+
    | g                |                    |    no constraint                                           |
    +------------------+--------------------+------------------------------------------------------------+
    | **WRITING OUTPUTS PARAMETERS**                                                                     |
    +------------------+--------------------+------------------------------------------------------------+
    | w_tecplot        |                    |  no constraint                                             |
    +------------------+--------------------+------------------------------------------------------------+
    | w_gnuplot        |                    |  no constraint                                             |
    +------------------+--------------------+------------------------------------------------------------+
    | w_vtk            |                    |   no constraint                                            |
    +------------------+--------------------+------------------------------------------------------------+
    | **ASSIMILATION PARAMETERS**          (always 0 to not activate and 1 to activate)                  |
    +------------------+--------------------+------------------------------------------------------------+
    | w_obs            |                    | obs.txt file must exist                                    |
    +------------------+--------------------+------------------------------------------------------------+
    | use_obs          |                    | w_obs = 1, obs.txt must exist                              |
    +------------------+--------------------+------------------------------------------------------------+
    | use_Qobs         |                    | ***                                                        |
    +------------------+--------------------+------------------------------------------------------------+
    | c_xxx            |                    | use_obs=1, w_obs =1                                        |
    +------------------+--------------------+------------------------------------------------------------+
    |max_nt_for_adjoint|                    | max_nt_for_adjoint>0                                       |
    +------------------+--------------------+------------------------------------------------------------+
    |restart_min       |                    |   no constraint                                            |
    +------------------+--------------------+------------------------------------------------------------+
    |eps_min           |                    |  eps_min>0                                                 |
    +------------------+--------------------+------------------------------------------------------------+
    |eps_xxx           |                    | ?                                                          |
    +------------------+--------------------+------------------------------------------------------------+


++++++++++++++++++++++++++++++++++++++++++
Take advantage of wrapped version
++++++++++++++++++++++++++++++++++++++++++

In the directory ``/dassflow2d-wrap/Tools/2_gen_basic_channel``, execute the commands:


.. code-block:: bash

  python3 -m numpy.f2py -c -m gen_channel_case _gen_channel_case.f90

_________________________________________
generate inputs from python
_________________________________________

Go to the directory  ``/dassflow2d-wrap/Tools/2_gen_basic_channel``
You can open the script in   ``script_example/1_define_input.py``, it corresponds to the following code:


.. code-block:: python

  os.chdir("/home/livillenave/Documents/distant/dassflow2d-wrap/Tools/2_gen_basic_channel")


  import gen_channel_case
  import gen_dassflow


  input_params = { "mesh_name":'channel.geo',
                    "ts":100,
                    "dta":100,
                    "dtw":10,
                    "dtp":10,
                    "dt":1,
                    "temp_scheme":'euler',
                    "spatial_scheme":'first_b1',
                    "adapt_dt":1,
                    "cfl":0.8,
                    "feedback_inflow":1,
                    "coef_feedback":0.8,
                    "heps":0,
                    "friction":1,
                    "g":10,
                    "w_tecplot":0,
                    "w_vtk":0,
                    "w_gnuplot":0,
                    "w_obs":0,
                    "use_obs":0,
                    "max_nt_for_adjoint":2500,
                    "c_manning":0,
                    "c_manning_beta":0,
                    "c_bathy":0,
                    "c_hydrograph":0,
                    "c_ratcurve":0,
                    "c_rain":0,
                    "c_infil":0,
                    "c_ic":0,
                    "restart_min":0,
                    "eps_min":0.0001}

  gen_dassflow.gen_input(input_param = input_params)

_____________________________________________________
Access and Update fortran kernel value in python
_____________________________________________________

Still in the directory ``/dassflow2d-wrap/Tools/2_gen_basic_channel``, execute the commands:


.. code-block:: bash

  python3 -m numpy.f2py -c -m gen_channel_case _gen_channel_case.f90
  python3 run.py

It generates necessary files in  ``/files/`` directory. paste them in your bin directory ( ``/dassflow2d-wrap/code/bin_A/`` ).


Then, open a python interpreter and enter the following code:
( the corresponding script can be found at ``script_example/2_get-set_input.py``)

.. warning::

  the path to the bin_dir in the script must be updated


.. code-block:: python

  import dassflow2d as df2d

  #=======================================================#
  #  Iinialise fortran model
  #=======================================================#
  # initialise fortran instance, and python corrponding data
  my_model = df2d.DassFlowModel(bin_dir = "path to your bin dir to be updated", run_type = "direct") # run_type can be min or direct (grad ?)


  #=======================================================#
  # ACESS input values
  #=======================================================#
  df2d.m_common.get_mesh_name().decode('utf-8')
  df2d.m_common.get_ts()
  df2d.m_common.get_dtw()
  df2d.m_common.get_dtp()
  df2d.m_common.get_temp_scheme().decode('utf-8')
  df2d.m_common.get_spatial_scheme().decode('utf-8')
  df2d.m_common.get_adapt_dt()
  df2d.m_common.get_dt()
  df2d.m_common.get_cfl()

  df2d.m_model.get_feedback_inflow()
  df2d.m_model.get_coef_feedback()
  df2d.m_model.get_heps()
  df2d.m_model.get_friction()
  df2d.m_model.get_g()

  df2d.m_common.get_w_tecplot()
  df2d.m_common.get_w_vtk()
  df2d.m_common.get_w_gnuplot()

  df2d.m_common.get_w_obs()
  df2d.m_common.get_use_obs()
  # df2d.xxxxx.get_max_nt_for_adjoint() ---> didn't found how to access it


  df2d.m_model.get_c_manning()
  df2d.m_model.get_c_manning_beta()
  df2d.m_model.get_c_bathy()
  df2d.m_model.get_c_hydrograph()
  df2d.m_model.get_c_ratcurve()
  df2d.m_model.get_c_rain()
  df2d.m_model.get_c_ic()


  df2d.m_common.get_restart_min()
  df2d.m_common.get_eps_min()




  #=======================================================#
  # Set input values (replace get by set)
  #=======================================================#

  df2d.m_common.set_ts(1000)

  #=======================================================#
  # run model
  #=======================================================#
  my_model.update_fortran()
  my_model.run()
  my_model.save_res()
