
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Inference run &#8212; DassFlow-2D 1.0 documentation</title>
  <script>
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=1e1de1a1873e13ef5536" rel="stylesheet">
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=1e1de1a1873e13ef5536" rel="stylesheet">

  
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/6.1.2/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/dassflow.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=1e1de1a1873e13ef5536">

    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'getting_started/Tutorials/3_make_your_first_4Dvar';</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Inference run using scipy.minimize" href="3_inference-python.html" />
    <link rel="prev" title="Forward run (simple channel “q_in”)" href="2_make_your_second_run.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="docsearch:language" content="en">
  </head>
  
  
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="180" data-default-mode="">

  
  <input type="checkbox" class="sidebar-toggle" name="__primary" id="__primary">
  <label class="overlay overlay-primary" for="__primary"></label>

  
  <input type="checkbox" class="sidebar-toggle" name="__secondary" id="__secondary">
  <label class="overlay overlay-secondary" for="__secondary"></label>

  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
      
<form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search the docs ..." aria-label="Search the docs ..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  </div>

  
  <nav class="bd-header navbar navbar-expand-lg bd-navbar" id="navbar-main"><div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
      <span class="fa-solid fa-bars"></span>
  </label>
  <div id="navbar-start">
    
    
  


<a class="navbar-brand logo" href="../../index.html">

  
  
  
  
  
  
  

  
  
    <p class="title logo__title">DassFlow-2D 1.0 documentation</p>
  
</a>
    
  </div>

  
  <div class="col-lg-9 navbar-header-items">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="../../Introduction/index.html">
                        Presentation
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="../index.html">
                        Getting started
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../user_guide/index.html">
                        User Guide
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../reference/index.html">
                        API Reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../numerical_guide/index.html">
                        Numerical Guide
                    </a>
                </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                <li class="nav-item">
                    <a class="nav-link" href="../../license/index.html">
                        License
                    </a>
                </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
    </div>

    <div id="navbar-end">
      <div class="navbar-end-item navbar-end__search-button-container">
        
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
      </div>
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" data-toggle="tooltip">
    <a class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="fa-regular fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
  </div>


  
  <div class="search-button-container--mobile">
<button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" data-toggle="tooltip">
  <i class="fa-solid fa-magnifying-glass"></i>
</button>
  </div>

  
  <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
  </label>
  

</div>
  </nav>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        
  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
      
      <div class="navbar-center-item">
        <nav class="navbar-nav">
    <p class="sidebar-header-items__title" role="heading" aria-level="1" aria-label="Site Navigation">
        Site Navigation
    </p>
    <ul id="navbar-main-elements" class="navbar-nav">
        
                <li class="nav-item">
                    <a class="nav-link" href="../../Introduction/index.html">
                        Presentation
                    </a>
                </li>
                

                <li class="nav-item current active">
                    <a class="nav-link" href="../index.html">
                        Getting started
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../user_guide/index.html">
                        User Guide
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../reference/index.html">
                        API Reference
                    </a>
                </li>
                

                <li class="nav-item">
                    <a class="nav-link" href="../../numerical_guide/index.html">
                        Numerical Guide
                    </a>
                </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                <li class="nav-item">
                    <a class="nav-link" href="../../license/index.html">
                        License
                    </a>
                </li>
                
                </div>
            </div>
            
    </ul>
</nav>
      </div>
      
      </div>
    

    
    
    <div class="sidebar-header-items__end">
      
      <div class="navbar-end-item">
        <span class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" data-toggle="tooltip">
    <a class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></a>
    <a class="theme-switch" data-mode="dark"><i class="fa-regular fa-moon"></i></a>
    <a class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></a>
</span>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
      </ul>
      </div>
      
    </div>
    
  </div>

  
  <div class="sidebar-start-items sidebar-primary__section">
    <div class="sidebar-start-items__item"><nav class="bd-links" id="bd-docs-nav" aria-label="Section navigation">
  <p class="bd-links__title" role="heading" aria-level="1">
    Section Navigation
  </p>
  <div class="bd-toc-item navbar-nav">
    <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../Installation/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compilation/index.html">compilation</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_make_your_first_run.html">Forward run (lake at rest)</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_make_your_second_run.html">Forward run (simple channel “q_in”)</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Inference run</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_inference-python.html">Inference run using scipy.minimize</a></li>
<li class="toctree-l1"><a class="reference internal" href="4_upgrade-to-parallel.html">Upgrade to parallel</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_gen-user-data.html">Generate  Basic channel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CodingPhilosophy/index.html">Coding Philosophy</a></li>
</ul>

  </div>
</nav>
    </div>
  </div>
  

  
  <div class="sidebar-end-items sidebar-primary__section">
    <div class="sidebar-end-items__item">
    </div>
  </div>

      </div>
      <main class="bd-main">
        
        
        <div class="bd-content">
          <div class="bd-article-container">
            
            <div class="bd-header-article">
                
            </div>
            
            
            <article class="bd-article" role="main">
              
  <section id="inference-run">
<span id="make-your-first-4dvar"></span><h1>Inference run<a class="headerlink" href="#inference-run" title="Permalink to this heading">#</a></h1>
<p>This tutorial details how to perform an inverse run with <code class="xref py py-obj docutils literal notranslate"><span class="pre">dassflow2d</span></code>. The full process is detailed for building and performing a twin experiment.  i.e. generating observations with a forward run given a true control vector, then using those observations to retrieve with the inverse VDA algorithm this true control vector starting from an a priori background value.
Here the control vector consists in one unknown discrete parameter among inflow hydrograph or channel friction or bathymetry, and it is retrieved from water level observations in the channel.</p>
<blockquote>
<div><p><a href="#id1"><span class="problematic" id="id2">**</span></a>TODO ref to eqs &amp; inv algo **</p>
</div></blockquote>
<p>The presented case correspond to the Mac Donald’s type 1D  solution (see shallow water analytical solutions in SWASHES cases <a class="reference external" href="https://hal.archives-ouvertes.fr/hal-00628246/file/SW_analytic-complements.pdf">https://hal.archives-ouvertes.fr/hal-00628246/file/SW_analytic-complements.pdf</a>).</p>
<div class="jupyter_cell jupyter_container docutils container">
<div class="cell_input code_cell docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dassflow2d</span> <span class="k">as</span> <span class="nn">df2d</span>              <span class="c1"># dassflow2d : main package</span>
<span class="kn">import</span> <span class="nn">os</span>                        <span class="c1"># os, for shell command execution (mainly for file manipulation)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="c1"># for os.chdir() command, to open current birectory as bin_directory, defined in parameters, just below</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="kn">import</span> <span class="n">call</span> <span class="c1"># terminal comand</span>

<span class="c1">##############</span>
<span class="c1"># put this in package ? assim/utils ?</span>
<span class="c1">##############</span>

<span class="c1"># method that copy pre-existing files to bin dir, used in the script</span>
<span class="c1"># source is the path of the source file and target is the path where to copy the file</span>
<span class="c1"># it directly use the shell</span>

<span class="k">def</span> <span class="nf">cp_inference_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;inference_files/</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">call</span><span class="p">([</span><span class="s1">&#39;rm&#39;</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span>
    <span class="n">call</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="c1"># Linux</span>


<span class="c1"># copy all reference files (for direct run)</span>
<span class="k">def</span> <span class="nf">cp_reference_file</span><span class="p">():</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;hydrograph_target.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;hydrograph.txt&#39;</span><span class="p">)</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;mesh_target.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;automaticaly_generated_mesh.txt&#39;</span><span class="p">)</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;land_uses_target.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;land_uses.txt&#39;</span><span class="p">)</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;input_direct.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;input.txt&#39;</span><span class="p">)</span>

<span class="c1"># cp_dir copy files from source directory to target directory.</span>
<span class="c1"># note that the directory is copied (not only the files within)</span>
<span class="k">def</span> <span class="nf">cp_dir</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">call</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="s1">&#39;-a&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="c1"># Linux</span>

<span class="c1"># save hdf5 (results) files out of /res directory</span>
<span class="k">def</span> <span class="nf">cp_hdf5_file</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;res/</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">target</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;hdf5/</span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s1">&#39;</span>
<span class="c1">#    call([&#39;mkdir&#39;, &quot;hdf5&quot;])</span>
<span class="c1">#    call([&#39;rm&#39;, target])</span>
    <span class="n">call</span><span class="p">([</span><span class="s1">&#39;cp&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">])</span> <span class="c1"># Linux</span>

<span class="c1">#######################################</span>
<span class="c1">#######################################</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s1">&#39;../../&#39;</span><span class="p">)</span>
<span class="n">dassflow_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span> <span class="c1"># DassFlow directory (you can also impose your absolute path)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">dassflow_dir</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DassFlow directory is: &quot;</span><span class="p">,</span> <span class="n">dassflow_dir</span><span class="p">)</span>

<span class="c1"># Define directory where case is run</span>
<span class="c1"># (its name &#39;bin_A&#39; is imposed in  {dassflow_dir}/code/makefile.inc : CASEDIR=&#39;bin_A&#39;)</span>
<span class="n">bin_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/code/bin_A/&quot;</span>

<span class="c1"># Define directory containing case data</span>
<span class="n">case_data_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/cases/tuto_case/2_qin/bin_A/&quot;</span>

<span class="c1"># Delete all files in your simulation directory before starting</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm -r </span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/code/bin_A/*&quot;</span><span class="p">)</span>

<span class="c1"># Copy recursively the files provided in DassFlow case repository into your own simulation directory **code/bin_A/**.</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cp -r </span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">//cases/tuto_case/2_tuto_twin-expe/bin_A/* </span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/code/bin_A&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/code/&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;make cleanres cleanmin &quot;</span><span class="p">)</span>

<span class="c1">#=======================================================#</span>
<span class="c1"># set up true configuration</span>
<span class="c1">#=======================================================#</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">)</span>
<span class="n">cp_reference_file</span><span class="p">()</span>

<span class="c1">#=======================================================#</span>
<span class="c1"># direct run of the  model</span>
<span class="c1">#=======================================================#</span>

<span class="c1"># initialise fortran instance, and python corrponding data</span>
<span class="n">direct_model</span> <span class="o">=</span> <span class="n">df2d</span><span class="o">.</span><span class="n">dassflowmodel</span><span class="p">(</span><span class="n">bin_dir</span> <span class="o">=</span> <span class="n">bin_dir</span><span class="p">,</span> <span class="n">hdf5_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/code/bin_A/res/simu.hdf5&quot;</span><span class="p">,</span> <span class="n">run_type</span> <span class="o">=</span> <span class="s2">&quot;direct&quot;</span><span class="p">,</span> <span class="n">clean</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="c1"># then intialise meshing</span>
<span class="n">direct_model</span><span class="o">.</span><span class="n">init_all</span><span class="p">()</span>
<span class="c1"># define initial conditions</span>
<span class="n">direct_model</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">dof0</span><span class="o">.</span><span class="n">h</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">direct_model</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">dof0</span><span class="o">.</span><span class="n">u</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">direct_model</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">dof0</span><span class="o">.</span><span class="n">v</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">direct_model</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="n">direct_model</span><span class="o">.</span><span class="n">kernel</span><span class="o">.</span><span class="n">dof0</span>

<span class="n">direct_model</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="n">direct_model</span><span class="o">.</span><span class="n">save_all</span><span class="p">()</span> <span class="c1"># save simulation results in hdf5 files</span>

<span class="n">cp_hdf5_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s2">&quot;simu.hdf5&quot;</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="s2">&quot;true.hdf5&quot;</span><span class="p">)</span> <span class="c1">#save hdf5 (results) files out of /res directory</span>
<span class="n">cp_dir</span><span class="p">(</span><span class="s1">&#39;./res/obs&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span> <span class="c1"># copy observation files</span>

<span class="n">df2d</span><span class="o">.</span><span class="n">wrapping</span><span class="o">.</span><span class="n">call_model</span><span class="o">.</span><span class="n">clean_model</span><span class="p">(</span><span class="n">direct_model</span><span class="o">.</span><span class="n">kernel</span><span class="p">)</span>         <span class="c1"># deallocate correctly (necessary action)</span>

<span class="c1">#----------- some plots to add</span>

<span class="c1">###########################################################</span>
<span class="c1">#===========================================================</span>
<span class="c1"># RUN INFERENCE</span>
<span class="c1">#===========================================================</span>
<span class="c1">###########################################################</span>

<span class="c1">#----------------------#</span>
<span class="c1">#  Define Parameters</span>
<span class="c1">#----------------------#</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dassflow_dir</span><span class="si">}</span><span class="s2">/code/&quot;</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;make cleanres cleanmin &quot;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">bin_dir</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rm restart.bin &quot;</span><span class="p">)</span>

<span class="c1"># /!\ warning :: bathymetry not inferable ? --&gt; lilian = optim not find optimum</span>
<span class="c1">#print(&quot;CHOOSE INFERENCE TYPE (1 hydrograph, 2 land_use, 3 = bathy)&quot;)</span>
<span class="n">inference_type</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1">#input(&quot;Enter 1,2 or 3 \n&quot;)</span>

<span class="k">if</span> <span class="n">inference_type</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span><span class="p">:</span>
    <span class="c1"># -- infer hydrograph --</span>
    <span class="n">cp_reference_file</span><span class="p">()</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;hydrograph_prior.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;hydrograph.txt&#39;</span><span class="p">)</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;input_hydrograph.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;input.txt&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">inference_type</span> <span class="o">==</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span>
    <span class="c1"># -- same for manning -- #</span>
    <span class="n">cp_reference_file</span><span class="p">()</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;land_uses_prior.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;land_uses.txt&#39;</span><span class="p">)</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;input_land_uses.txt&#39;</span> <span class="p">,</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;input.txt&#39;</span><span class="p">)</span>

<span class="k">elif</span> <span class="n">inference_type</span> <span class="o">==</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span>
    <span class="c1"># -- infer hydrograph --#</span>
    <span class="n">cp_reference_file</span><span class="p">()</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;mesh_prior.txt&#39;</span> <span class="p">,</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;automaticaly_generated_mesh.txt.txt&#39;</span><span class="p">)</span>
    <span class="n">cp_inference_file</span><span class="p">(</span><span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;input_bathy.txt&#39;</span> <span class="p">,</span>
                        <span class="n">target</span> <span class="o">=</span> <span class="s1">&#39;input.txt&#39;</span><span class="p">)</span>

<span class="c1">#=======================================================#</span>
<span class="c1"># Inference</span>
<span class="c1">#=======================================================#</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span>DassFlow directory is:  /home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d
make[1]: Entering directory &#39;/home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d/code&#39;
rm -rf ./bin_A/res/*
rm -rf ./bin_A/graph/*
rm -rf ./bin_A/min/*
make[1]: Leaving directory &#39;/home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d/code&#39;
clean= True
call dassflow2d.wrapping.m_mesh.msh()
call         dassflow2d.wrapping.call_model.init_solver(self.kernel)
call   Meshing(mesh_fortran = self.kernel.mesh)

================================================================================
*  Mesh Loading                                                                *
================================================================================
  mesh%file_nameautomaticaly_generated_mesh.txt                                                                                                 
 INTO calc_cells_connectivity
 STEP 1 DONE
 OUT calc_cells_connectivity
 INLET            1           1
 OUTLET           1           1
================================================================================
*  Mesh Loading is OK                                                          *
================================================================================
 Read_Dass_Mesh OK --&gt; go out
  call Read_Dass_Mesh( mesh ) done 
  call Mesh_Partition_Scotch( mesh ) 
  call Mesh_Geometric_Properties( mesh ) 
  done mesh input 
 call Machine_Number_Limits
 DONE Machine_Number_Limits

********************************************************************************
 range     =             307
 precision =              15
 zerom     =   1.0730891E-16
 pinfm     =   9.4967820E+15
 minfm     =  -9.4967820E+15
 hugem     =   1.7976931+308
 tinym     =   2.2250739-308
********************************************************************************
 call Init_Linear_Solver(mdl%mesh)
 done Init_Linear_Solver(mdl%mesh)

================================================================================
*  Running Shallow-Water Model in direct mode                                  *
================================================================================
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =       20 t =  1.02807E+01 /  1.00000E+03 (   1.0 % ) , dt =  4.624678E-01
nt =       43 t =  2.04147E+01 /  1.00000E+03 (   2.0 % ) , dt =  4.239186E-01
nt =       67 t =  3.02865E+01 /  1.00000E+03 (   3.0 % ) , dt =  4.023877E-01
nt =       92 t =  4.02096E+01 /  1.00000E+03 (   4.0 % ) , dt =  3.933473E-01
nt =      117 t =  5.00088E+01 /  1.00000E+03 (   5.0 % ) , dt =  3.915066E-01
nt =      143 t =  6.02079E+01 /  1.00000E+03 (   6.0 % ) , dt =  3.934427E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =      168 t =  7.00886E+01 /  1.00000E+03 (   7.0 % ) , dt =  3.970610E-01
nt =      193 t =  8.00720E+01 /  1.00000E+03 (   8.0 % ) , dt =  4.014881E-01
nt =      218 t =  9.01643E+01 /  1.00000E+03 (   9.0 % ) , dt =  4.056841E-01
nt =      243 t =  1.00359E+02 /  1.00000E+03 (  10.0 % ) , dt =  4.096675E-01
nt =      267 t =  1.10238E+02 /  1.00000E+03 (  11.0 % ) , dt =  4.134329E-01
nt =      291 t =  1.20204E+02 /  1.00000E+03 (  12.0 % ) , dt =  4.167641E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =      315 t =  1.30235E+02 /  1.00000E+03 (  13.0 % ) , dt =  4.188362E-01
nt =      339 t =  1.40295E+02 /  1.00000E+03 (  14.0 % ) , dt =  4.192003E-01
nt =      363 t =  1.50346E+02 /  1.00000E+03 (  15.0 % ) , dt =  4.182930E-01
nt =      387 t =  1.60369E+02 /  1.00000E+03 (  16.0 % ) , dt =  4.170014E-01
nt =      411 t =  1.70361E+02 /  1.00000E+03 (  17.0 % ) , dt =  4.158384E-01
nt =      435 t =  1.80331E+02 /  1.00000E+03 (  18.0 % ) , dt =  4.150800E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =      459 t =  1.90288E+02 /  1.00000E+03 (  19.0 % ) , dt =  4.147293E-01
nt =      483 t =  2.00240E+02 /  1.00000E+03 (  20.0 % ) , dt =  4.146528E-01
nt =      507 t =  2.10201E+02 /  1.00000E+03 (  21.0 % ) , dt =  4.155912E-01
nt =      531 t =  2.20198E+02 /  1.00000E+03 (  22.0 % ) , dt =  4.176119E-01
nt =      555 t =  2.30253E+02 /  1.00000E+03 (  23.0 % ) , dt =  4.202367E-01
nt =      579 t =  2.40375E+02 /  1.00000E+03 (  24.0 % ) , dt =  4.231904E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =      602 t =  2.50144E+02 /  1.00000E+03 (  25.0 % ) , dt =  4.261625E-01
nt =      626 t =  2.60411E+02 /  1.00000E+03 (  26.0
</pre></div>
</div>
<div class="output stream highlight-none notranslate"><div class="highlight"><pre><span></span> % ) , dt =  4.292915E-01
nt =      649 t =  2.70320E+02 /  1.00000E+03 (  27.0 % ) , dt =  4.322378E-01
nt =      672 t =  2.80296E+02 /  1.00000E+03 (  28.0 % ) , dt =  4.350802E-01
nt =      695 t =  2.90336E+02 /  1.00000E+03 (  29.0 % ) , dt =  4.377847E-01
nt =      718 t =  3.00436E+02 /  1.00000E+03 (  30.0 % ) , dt =  4.403304E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =      740 t =  3.10149E+02 /  1.00000E+03 (  31.0 % ) , dt =  4.426063E-01
nt =      763 t =  3.20356E+02 /  1.00000E+03 (  32.0 % ) , dt =  4.448151E-01
nt =      785 t =  3.30165E+02 /  1.00000E+03 (  33.0 % ) , dt =  4.467651E-01
nt =      807 t =  3.40015E+02 /  1.00000E+03 (  34.0 % ) , dt =  4.485598E-01
nt =      830 t =  3.50352E+02 /  1.00000E+03 (  35.0 % ) , dt =  4.502760E-01
nt =      852 t =  3.60276E+02 /  1.00000E+03 (  36.0 % ) , dt =  4.517721E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =      874 t =  3.70231E+02 /  1.00000E+03 (  37.0 % ) , dt =  4.531339E-01
nt =      896 t =  3.80214E+02 /  1.00000E+03 (  38.0 % ) , dt =  4.543701E-01
nt =      918 t =  3.90223E+02 /  1.00000E+03 (  39.0 % ) , dt =  4.554894E-01
nt =      940 t =  4.00256E+02 /  1.00000E+03 (  40.0 % ) , dt =  4.565005E-01
nt =      962 t =  4.10310E+02 /  1.00000E+03 (  41.0 % ) , dt =  4.574120E-01
nt =      984 t =  4.20382E+02 /  1.00000E+03 (  42.0 % ) , dt =  4.582320E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1005 t =  4.30013E+02 /  1.00000E+03 (  43.0 % ) , dt =  4.589367E-01
nt =     1027 t =  4.40117E+02 /  1.00000E+03 (  44.0 % ) , dt =  4.596004E-01
nt =     1049 t =  4.50236E+02 /  1.00000E+03 (  45.0 % ) , dt =  4.601946E-01
nt =     1071 t =  4.60366E+02 /  1.00000E+03 (  46.0 % ) , dt =  4.607260E-01
nt =     1092 t =  4.70046E+02 /  1.00000E+03 (  47.0 % ) , dt =  4.611801E-01
nt =     1114 t =  4.80197E+02 /  1.00000E+03 (  48.0 % ) , dt =  4.616056E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1136 t =  4.90357E+02 /  1.00000E+03 (  49.0 % ) , dt =  4.619848E-01
nt =     1157 t =  5.00062E+02 /  1.00000E+03 (  50.0 % ) , dt =  4.623078E-01
nt =     1179 t =  5.10237E+02 /  1.00000E+03 (  51.0 % ) , dt =  4.626097E-01
nt =     1201 t =  5.20417E+02 /  1.00000E+03 (  52.0 % ) , dt =  4.628780E-01
nt =     1222 t =  5.30140E+02 /  1.00000E+03 (  53.0 % ) , dt =  4.631061E-01
nt =     1244 t =  5.40331E+02 /  1.00000E+03 (  54.0 % ) , dt =  4.633187E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1265 t =  5.50063E+02 /  1.00000E+03 (  55.0 % ) , dt =  4.634993E-01
nt =     1287 t =  5.60262E+02 /  1.00000E+03 (  56.0 % ) , dt =  4.636674E-01
nt =     1308 t =  5.70000E+02 /  1.00000E+03 (  57.0 % ) , dt =  4.638100E-01
nt =     1330 t =  5.80206E+02 /  1.00000E+03 (  58.0 % ) , dt =  4.639427E-01
nt =     1352 t =  5.90414E+02 /  1.00000E+03 (  59.0 % ) , dt =  4.640602E-01
nt =     1373 t =  6.00160E+02 /  1.00000E+03 (  60.0 % ) , dt =  4.641597E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1395 t =  6.10373E+02 /  1.00000E+03 (  61.0 % ) , dt =  4.642522E-01
nt =     1416 t =  6.20123E+02 /  1.00000E+03 (  62.0 % ) , dt =  4.643305E-01
nt =     1438 t =  6.30339E+02 /  1.00000E+03 (  63.0 % ) , dt =  4.644033E-01
nt =     1459 t =  6.40092E+02 /  1.00000E+03 (  64.0 % ) , dt =  4.644648E-01
nt =     1481 t =  6.50311E+02 /  1.00000E+03 (  65.0 % ) , dt =  4.645220E-01
nt =     1502 t =  6.60067E+02 /  1.00000E+03 (  66.0 % ) , dt =  4.645704E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1524 t =  6.70288E+02 /  1.00000E+03 (  67.0 % ) , dt =  4.646152E-01
nt =     1545 t =  6.80045E+02 /  1.00000E+03 (  68.0 % ) , dt =  4.646532E-01
nt =     1567 t =  6.90268E+02 /  1.00000E+03 (  69.0 % ) , dt =  4.646884E-01
nt =     1588 t =  7.00027E+02 /  1.00000E+03 (  70.0 % ) , dt =  4.647182E-01
nt =     1610 t =  7.10251E+02 /  1.00000E+03 (  71.0 % ) , dt =  4.647458E-01
nt =     1631 t =  7.20011E+02 /  1.00000E+03 (  72.0 % ) , dt =  4.647691E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1653 t =  7.30236E+02 /  1.00000E+03 (  73.0 % ) , dt =  4.647908E-01
nt =     1675 t =  7.40462E+02 /  1.00000E+03 (  74.0 % ) , dt =  4.648099E-01
nt =     1696 t =  7.50223E+02 /  1.00000E+03 (  75.0 % ) , dt =  4.648260E-01
nt =     1718 t =  7.60449E+02 /  1.00000E+03 (  76.0 % ) , dt =  4.648410E-01
nt =     1739 t =  7.70211E+02 /  1.00000E+03 (  77.0 % ) , dt =  4.648537E-01
nt =     1761 t =  7.80438E+02 /  1.00000E+03 (  78.0 % ) , dt =  4.648654E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1782 t =  7.90200E+02 /  1.00000E+03 (  79.0 % ) , dt =  4.648753E-01
nt =     1804 t =  8.00427E+02 /  1.00000E+03 (  80.0 % ) , dt =  4.648845E-01
nt =     1825 t =  8.10190E+02 /  1.00000E+03 (  81.0 % ) , dt =  4.648923E-01
nt =     1847 t =  8.20418E+02 /  1.00000E+03 (  82.0 % ) , dt =  4.648995E-01
nt =     1868 t =  8.30181E+02 /  1.00000E+03 (  83.0 % ) , dt =  4.649056E-01
nt =     1890 t =  8.40409E+02 /  1.00000E+03 (  84.0 % ) , dt =  4.649112E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     1911 t =  8.50172E+02 /  1.00000E+03 (  85.0 % ) , dt =  4.649160E-01
nt =     1933 t =  8.60400E+02 /  1.00000E+03 (  86.0 % ) , dt =  4.649204E-01
nt =     1954 t =  8.70164E+02 /  1.00000E+03 (  87.0 % ) , dt =  4.649241E-01
nt =     1976 t =  8.80392E+02 /  1.00000E+03 (  88.0 % ) , dt =  4.649276E-01
nt =     1997 t =  8.90155E+02 /  1.00000E+03 (  89.0 % ) , dt =  4.649305E-01
nt =     2019 t =  9.00384E+02 /  1.00000E+03 (  90.0 % ) , dt =  4.649332E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     2040 t =  9.10148E+02 /  1.00000E+03 (  91.0 % ) , dt =  4.649355E-01
nt =     2062 t =  9.20376E+02 /  1.00000E+03 (  92.0 % ) , dt =  4.649376E-01
nt =     2083 t =  9.30140E+02 /  1.00000E+03 (  93.0 % ) , dt =  4.649394E-01
nt =     2105 t =  9.40369E+02 /  1.00000E+03 (  94.0 % ) , dt =  4.649410E-01
nt =     2126 t =  9.50132E+02 /  1.00000E+03 (  95.0 % ) , dt =  4.649424E-01
nt =     2148 t =  9.60361E+02 /  1.00000E+03 (  96.0 % ) , dt =  4.649437E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
nt =     2169 t =  9.70125E+02 /  1.00000E+03 (  97.0 % ) , dt =  4.649448E-01
nt =     2191 t =  9.80354E+02 /  1.00000E+03 (  98.0 % ) , dt =  4.649459E-01
nt =     2212 t =  9.90118E+02 /  1.00000E+03 (  99.0 % ) , dt =  4.649467E-01
nt =     2234 t =  1.00000E+03 /  1.00000E+03 ( 100.0 % ) , dt =  1.184916E-01
================================================================================
*  Writing Result File                                                         *
================================================================================
================================================================================
*  End of run of the Shallow-Water Model in direct mode                        *
================================================================================

********************************************************************************
 Time of simulation   =              0.16
********************************************************************************
 Performance          =              0.70 microsecond / dx / dt / proc
********************************************************************************
&gt;&gt;&gt; Outputs initialized 
 - Simulation Result files were loaded from : /home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d/code/bin_A//res/ 

Results.save(): File /home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d/code/bin_A/res/simu.hdf5 updated with Result class data
make[1]: Entering directory &#39;/home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d/code&#39;
rm -rf ./bin_A/res/*
rm -rf ./bin_A/graph/*
rm -rf ./bin_A/min/*
make[1]: Leaving directory &#39;/home/pagarambois/Documents/Distant/dassflow2d_git_/dassflow2d/code&#39;
</pre></div>
</div>
</div>
</div>
</section>


            </article>
            
            
            
            <footer class="bd-footer-article">
                <!-- Previous / next buttons -->
<div class='prev-next-area'>
  <a class='left-prev' id="prev-link" href="2_make_your_second_run.html" title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
          <p class="prev-next-subtitle">previous</p>
          <p class="prev-next-title">Forward run (simple channel “q_in”)</p>
      </div>
  </a>
  <a class='right-next' id="next-link" href="3_inference-python.html" title="next page">
  <div class="prev-next-info">
      <p class="prev-next-subtitle">next</p>
      <p class="prev-next-title">Inference run using scipy.minimize</p>
  </div>
  <i class="fa-solid fa-angle-right"></i>
  </a>
</div>
            </footer>
            
          </div>
          
          
          
            <div class="bd-sidebar-secondary bd-toc">
              
<div class="toc-item">
  
<div id="searchbox"></div>
</div>

<div class="toc-item">
  

<div class="tocsection editthispage">
    <a href="https://gitlab.irstea.fr//lilian.villenave/dassflow2d-wrap/-/edit/documentation//doc/SPHINX_DOCUMENTATION/source/getting_started/Tutorials/3_make_your_first_4Dvar.rst">
        <i class="fa-solid fa-pencil"></i> Edit this page
    </a>
</div>

</div>

<div class="toc-item">
  
<div class="tocsection sourcelink">
    <a href="../../_sources/getting_started/Tutorials/3_make_your_first_4Dvar.rst.txt">
        <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
</div>

</div>

            </div>
          
          
        </div>
        <footer class="bd-footer-content">
          <div class="bd-footer-content__inner">
            
          </div>
        </footer>
        
      </main>
    </div>
  </div>

  
    
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/pydata-sphinx-theme.js?digest=1e1de1a1873e13ef5536"></script>

  <footer class="bd-footer"><div class="bd-footer__inner container">
  
  <div class="footer-item">
    
<p class="copyright">

    &copy; Copyright Under Cecil licence.<br>

</p>

  </div>
  
  <div class="footer-item">
    
<p class="sphinx-version">
Created using <a href="http://sphinx-doc.org/">Sphinx</a> 5.3.0.<br>
</p>

  </div>
  
</div>
  </footer>
  </body>
</html>